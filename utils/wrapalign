#!/usr/bin/perl

use warnings;
use strict;

local $/ = "";

my $lw = 160;

if (@ARGV && $ARGV[0] =~ /^\d+$/) {
  $lw = shift @ARGV;
}

while (<>) {

  chomp; my $par = $_;
  my @lines = split "\n", $par;
  my @pre = ();
  my @aln = ();
  my @post = ();
  my $aln_pointer = 0;

  while (my $l = shift @lines) {
    if ($l =~ /^\+\+ /) {
      $aln[$aln_pointer] .= substr($l, 3);
      $aln_pointer++;
    }
    elsif ($l eq '.') {
      $aln_pointer = 0;
    }
    else {
      if (@aln) { push @post, $l } else { push @pre, $l }
    }
  }

  for my $l (@pre) { print "$l\n"; }
  for my $l (@post) { print "$l\n"; }

  my $o = 0;
  if (@aln) {
    while ($o < length($aln[0])) {
      print join "\n", map { '++ ' . substr($_, $o, $lw) } @aln;
      print "\n.\n";
      $o += $lw;
    }
  }
  else {
    print STDERR "No alignment found at $.\n";
  }
  for my $l (@post) { print "$l\n"; }
  print "\n\n";
}

